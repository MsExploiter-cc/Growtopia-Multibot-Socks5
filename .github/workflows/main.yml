name: Build New-Project from ZIP and send EXE to Telegram

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Extract New-Project.zip
        shell: pwsh
        run: |
          if (Test-Path "New-Project") {
            Remove-Item -Recurse -Force "New-Project"
          }

          if (-not (Test-Path "New-Project.zip")) {
            Write-Error "File New-Project.zip tidak ditemukan di root repo."
            exit 1
          }

          Expand-Archive -Path "New-Project.zip" -DestinationPath "."

          Write-Host "Isi folder setelah extract:"
          Get-ChildItem -Recurse

      - name: Install 7zip (for .rar vendor)
        shell: pwsh
        run: |
          choco install 7zip -y
          "$((Get-Command 7z).Source)" | Write-Host

      - name: Extract vendor .rar (imgui, enet, lua)
        shell: pwsh
        run: |
          $sevenZip = (Get-Command 7z).Source
          if (-not $sevenZip) {
            Write-Error "7z.exe tidak ditemukan."
            exit 1
          }

          $base = "New-Project/vendor"

          $archives = @(
            "imgui.rar",
            "enet.rar",
            "lua.rar"
          )

          foreach ($arc in $archives) {
            $arcPath = Join-Path $base $arc
            if (Test-Path $arcPath) {
              $outDir = Join-Path $base ([System.IO.Path]::GetFileNameWithoutExtension($arc))
              Write-Host "Extract $arcPath -> $outDir"
              New-Item -ItemType Directory -Force -Path $outDir | Out-Null
              & $sevenZip x $arcPath "-o$outDir" -y
            } else {
              Write-Warning "Archive tidak ditemukan: $arcPath"
            }
          }

          Write-Host "Cek isi vendor setelah extract:"
          Get-ChildItem -Recurse "New-Project/vendor"

      - name: Build Release x64
        shell: pwsh
        run: |
          if (-not (Test-Path "New-Project.sln")) {
            Write-Error "New-Project.sln tidak ditemukan di root. Jika ada di subfolder, ubah path msbuild."
            exit 1
          }

          msbuild "New-Project.sln" /p:Configuration=Release /p:Platform=x64

      - name: Upload artifact (EXE)
        uses: actions/upload-artifact@v4
        with:
          name: New-Project-Release-x64
          path: |
            New-Project/x64/Release/*.exe

      - name: Send EXE to Telegram
        shell: pwsh
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if (-not $env:TELEGRAM_BOT_TOKEN) {
            Write-Error "Secret TELEGRAM_BOT_TOKEN belum di-set."
            exit 1
          }
          if (-not $env:TELEGRAM_CHAT_ID) {
            Write-Error "Secret TELEGRAM_CHAT_ID belum di-set."
            exit 1
          }

          $exe = Get-ChildItem -Path "New-Project/x64/Release" -Filter "*.exe" -File -Recurse | Select-Object -First 1

          if (-not $exe) {
            Write-Error "File EXE tidak ditemukan di New-Project/x64/Release."
            exit 1
          }

          Write-Host "Mengirim file:" $exe.FullName

          $url = "https://api.telegram.org/bot$($env:TELEGRAM_BOT_TOKEN)/sendDocument"

          $form = @{
            chat_id = $env:TELEGRAM_CHAT_ID
            document = Get-Item $exe.FullName
            caption = "Build terbaru: $($exe.Name)"
          }

          try {
            $response = Invoke-RestMethod -Uri $url -Method Post -Form $form
            Write-Host "Berhasil mengirim ke Telegram. Message ID:" $response.result.message_id
          }
          catch {
            Write-Error "Gagal mengirim ke Telegram: $($_.Exception.Message)"
            if ($_.Exception.Response -ne $null) {
              $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
              $responseBody = $reader.ReadToEnd()
              Write-Error "Response body: $responseBody"
            }
            exit 1
          }
