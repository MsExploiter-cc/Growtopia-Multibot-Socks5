name: Build New-Project from ZIP and send EXE to Telegram

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Extract New-Project.zip
        shell: pwsh
        run: |
          if (Test-Path "New-Project") {
            Remove-Item -Recurse -Force "New-Project"
          }

          if (-not (Test-Path "New-Project.zip")) {
            Write-Error "File New-Project.zip tidak ditemukan di root repo."
            exit 1
          }

          Expand-Archive -Path "New-Project.zip" -DestinationPath "."

          Write-Host "Isi folder setelah extract:"
          Get-ChildItem -Recurse

      - name: Install 7zip (for .rar vendor)
        shell: pwsh
        run: |
          choco install 7zip -y
          $sevenZip = Get-Command 7z -ErrorAction SilentlyContinue
          if (-not $sevenZip) {
            Write-Error "7z.exe tidak ditemukan setelah install. Step ini wajib sukses."
            exit 1
          }
          Write-Host "7z path:" $sevenZip.Source

      - name: Extract vendor .rar and fix layout
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $sevenZip = (Get-Command 7z).Source
          $base = "New-Project/vendor"

          if (-not (Test-Path $base)) {
            Write-Error "Folder vendor tidak ditemukan di New-Project/vendor."
            exit 1
          }

          # 1) Extract semua .rar ke vendor/ (bukan ke subfolder)
          $archives = Get-ChildItem -Path $base -Filter "*.rar" -File
          if (-not $archives) {
            Write-Warning "Tidak ada file .rar di vendor. Lewati extract."
          } else {
            foreach ($arc in $archives) {
              Write-Host "Extract $($arc.FullName) -> $base"
              & $sevenZip x $arc.FullName "-o$base" -y | Write-Host
            }
          }

          Write-Host "Isi vendor setelah extract:"
          Get-ChildItem -Recurse $base

          # 2) Pastikan ENet di vendor/enet/include/enet.h
          $enetIncludeDir = Join-Path $base "enet/include"
          $enetHeaderTarget = Join-Path $enetIncludeDir "enet.h"
          if (-not (Test-Path $enetHeaderTarget)) {
            $enetHeader = Get-ChildItem -Path $base -Filter "enet.h" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($enetHeader) {
              Write-Host "Menemukan enet.h di $($enetHeader.FullName), copy ke $enetHeaderTarget"
              New-Item -ItemType Directory -Force -Path $enetIncludeDir | Out-Null
              Copy-Item $enetHeader.FullName -Destination $enetHeaderTarget -Force
            } else {
              Write-Warning "enet.h tidak ditemukan di vendor. ENet include akan tetap error."
            }
          } else {
            Write-Host "enet.h sudah ada di $enetHeaderTarget"
          }

          # 3) Pastikan Lua di vendor/lua/lua.hpp
          $luaDir = Join-Path $base "lua"
          $luaHeaderTarget = Join-Path $luaDir "lua.hpp"
          if (-not (Test-Path $luaHeaderTarget)) {
            $luaHeader = Get-ChildItem -Path $base -Filter "lua.hpp" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($luaHeader) {
              Write-Host "Menemukan lua.hpp di $($luaHeader.FullName), copy ke $luaHeaderTarget"
              New-Item -ItemType Directory -Force -Path $luaDir | Out-Null
              Copy-Item $luaHeader.FullName -Destination $luaHeaderTarget -Force
            } else {
              Write-Warning "lua.hpp tidak ditemukan di vendor. Lua include akan tetap error."
            }
          } else {
            Write-Host "lua.hpp sudah ada di $luaHeaderTarget"
          }

          # 4) Pastikan ImGui di vendor/imgui/*
          $imguiDir = Join-Path $base "imgui"
          if (-not (Test-Path $imguiDir)) {
            New-Item -ItemType Directory -Force -Path $imguiDir | Out-Null
          }

          $imguiHeaderTarget = Join-Path $imguiDir "imgui.h"
          if (-not (Test-Path $imguiHeaderTarget)) {
            $imguiHeader = Get-ChildItem -Path $base -Filter "imgui.h" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($imguiHeader) {
              Write-Host "Menemukan imgui.h di $($imguiHeader.FullName), copy semua imgui*.* ke $imguiDir"
              # Copy semua file imgui*.h & imgui*.cpp dari folder sumber ke vendor/imgui
              Get-ChildItem -Path $imguiHeader.Directory.FullName -Filter "imgui*.h" -File | ForEach-Object {
                Copy-Item $_.FullName -Destination $imguiDir -Force
              }
              Get-ChildItem -Path $imguiHeader.Directory.FullName -Filter "imgui*.cpp" -File | ForEach-Object {
                Copy-Item $_.FullName -Destination $imguiDir -Force
              }
            } else {
              Write-Warning "imgui.h tidak ditemukan di vendor. ImGui include/source akan tetap error."
            }
          } else {
            Write-Host "imgui.h sudah ada di $imguiHeaderTarget"
          }

          Write-Host "Final layout vendor:"
          Get-ChildItem -Recurse $base

      - name: Build Release x64
        shell: pwsh
        run: |
          if (-not (Test-Path "New-Project.sln")) {
            Write-Error "New-Project.sln tidak ditemukan di root. Jika ada di subfolder, ubah path msbuild."
            exit 1
          }

          msbuild "New-Project.sln" /p:Configuration=Release /p:Platform=x64

      - name: Upload artifact (EXE)
        uses: actions/upload-artifact@v4
        with:
          name: New-Project-Release-x64
          path: |
            New-Project/x64/Release/*.exe

      - name: Send EXE to Telegram
        shell: pwsh
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if (-not $env:TELEGRAM_BOT_TOKEN) {
            Write-Error "Secret TELEGRAM_BOT_TOKEN belum di-set."
            exit 1
          }
          if (-not $env:TELEGRAM_CHAT_ID) {
            Write-Error "Secret TELEGRAM_CHAT_ID belum di-set."
            exit 1
          }

          $exe = Get-ChildItem -Path "New-Project/x64/Release" -Filter "*.exe" -File -Recurse | Select-Object -First 1

          if (-not $exe) {
            Write-Error "File EXE tidak ditemukan di New-Project/x64/Release."
            exit 1
          }

          Write-Host "Mengirim file:" $exe.FullName

          $url = "https://api.telegram.org/bot$($env:TELEGRAM_BOT_TOKEN)/sendDocument"

          $form = @{
            chat_id = $env:TELEGRAM_CHAT_ID
            document = Get-Item $exe.FullName
            caption = "Build terbaru: $($exe.Name)"
          }

          try {
            $response = Invoke-RestMethod -Uri $url -Method Post -Form $form
            Write-Host "Berhasil mengirim ke Telegram. Message ID:" $response.result.message_id
          }
          catch {
            Write-Error "Gagal mengirim ke Telegram: $($_.Exception.Message)"
            if ($_.Exception.Response -ne $null) {
              $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
              $responseBody = $reader.ReadToEnd()
              Write-Error "Response body: $responseBody"
            }
            exit 1
          }
